<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda - Sala 01</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary-blue: #0056b3; --danger-red: #b91c1c; --bg-dark: #0f172a; --glass: rgba(255, 255, 255, 0.90); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }

        body {
            background: #f3f4f6; height: 100vh; display: flex;
            justify-content: center; align-items: center; overflow: hidden;
            transition: all 0.8s ease; position: relative;
        }

        /* --- VISUAL LOCKDOWN --- */
        body.is-busy::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://images.unsplash.com/photo-1541888946425-d81bb19240f5?q=80&w=2070&auto=format&fit=crop');
            background-size: cover; background-position: center;
            filter: grayscale(100%) contrast(1.2) brightness(0.4); z-index: 0;
            opacity: 0; transition: opacity 0.8s ease;
        }
        body.is-busy::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(153, 27, 27, 0.6) 0%, rgba(0, 0, 0, 0.9) 100%);
            z-index: 0; opacity: 0; transition: opacity 0.8s ease;
        }
        body.is-busy::before, body.is-busy::after { opacity: 1; }

        /* Container */
        .container {
            width: 90%; max-width: 1200px; height: 85vh;
            background: var(--glass); border-radius: 30px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
            display: grid; grid-template-columns: 1.2fr 1.8fr;
            overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.8);
            position: relative; z-index: 10; transition: all 0.5s ease;
        }
        body.is-busy .container { box-shadow: 0 0 50px rgba(220, 38, 38, 0.6); border: 2px solid rgba(220, 38, 38, 0.3); }

        /* Sidebar */
        .status-panel {
            background: var(--primary-blue); color: white; padding: 40px;
            display: flex; flex-direction: column; justify-content: space-between;
            position: relative; overflow: hidden; transition: background 0.6s ease;
        }
        body.is-busy .status-panel { background: #991b1b; }
        
        .status-panel::after {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 60%); pointer-events: none;
        }

        .sidebar-logo { max-width: 180px; max-height: 80px; object-fit: contain; margin-bottom: 20px; z-index: 2; }
        .room-info h1 { font-size: 3.5rem; font-weight: 800; line-height: 1; margin-bottom: 5px; letter-spacing: -2px; }
        .room-info p { font-size: 1.1rem; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; }

        .room-info h1.status-ocupado { font-size: 4rem; text-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .room-info p.meeting-now {
            background: rgba(0,0,0,0.3); padding: 8px 12px; border-radius: 8px;
            display: inline-block; margin-top: 10px; border-left: 3px solid rgba(255,255,255,0.5);
        }

        .clock { font-size: 4.5rem; font-weight: 300; letter-spacing: -3px; line-height: 1; }
        .date { font-size: 1.1rem; opacity: 0.9; margin-top: 5px; }

        /* Agenda Panel */
        .schedule-panel { padding: 40px; background: white; overflow-y: auto; position: relative; }
        .schedule-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; border-bottom: 2px solid #f3f4f6; padding-bottom: 20px;
        }
        .schedule-header h2 { font-size: 1.8rem; color: #1f2937; font-weight: 700; }
        
        .header-actions { display: flex; gap: 10px; }

        .btn {
            text-decoration: none; font-weight: 600; padding: 10px 20px; border-radius: 12px;
            font-size: 0.9rem; display: flex; align-items: center; gap: 8px; transition: all 0.2s;
            border: none; cursor: pointer;
        }

        .btn-voltar { background: #f3f4f6; color: #64748b; }
        .btn-voltar:hover { background: #e2e8f0; }

        .btn-reservar { background: var(--primary-blue); color: white; box-shadow: 0 4px 12px rgba(0, 86, 179, 0.3); }
        .btn-reservar:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0, 86, 179, 0.4); }
        .btn-reservar:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; box-shadow: none; }

        /* Cards */
        .reservation-card {
            display: flex; align-items: center; background: white;
            border-left: 6px solid var(--primary-blue); padding: 25px;
            margin-bottom: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
            animation: slideIn 0.5s ease; transition: all 0.3s ease;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .time-slot { font-weight: 800; font-size: 1.3rem; color: var(--primary-blue); min-width: 130px; display: flex; flex-direction: column; }
        
        .reservation-card.active-card {
            background: #fff1f2; border-left-color: var(--danger-red);
            box-shadow: 0 10px 30px rgba(220, 38, 38, 0.15); transform: scale(1.02);
        }
        .reservation-card.active-card .time-slot { color: var(--danger-red); }
        
        .time-slot span { font-size: 0.8rem; color: #9ca3af; font-weight: 500; }
        .meeting-title { font-size: 1.2rem; font-weight: 700; color: #1f2937; margin-bottom: 5px; }
        .organizer { display: flex; align-items: center; font-size: 0.9rem; color: #6b7280; font-weight: 500; }
        .avatar { width: 28px; height: 28px; background: #e5e7eb; border-radius: 50%; margin-right: 10px; display: flex; justify-content: center; align-items: center; font-size: 0.75rem; font-weight: 700; }
        .tag { padding: 6px 14px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; margin-left: auto; text-transform: uppercase; }
        .tag.upcoming { background: #eff6ff; color: var(--primary-blue); }
        .tag.ongoing { background: #fef2f2; color: var(--danger-red); }

        /* --- MODAL DE RESERVA --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 100;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(5px); animation: fadeIn 0.3s;
        }
        .modal {
            background: white; width: 500px; padding: 40px; border-radius: 30px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align: center;
            animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal h2 { color: var(--primary-blue); margin-bottom: 10px; font-size: 2rem; }
        .modal p { color: #64748b; margin-bottom: 30px; }
        
        .duration-options { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .duration-btn {
            padding: 15px; border: 2px solid #e2e8f0; background: white; border-radius: 15px;
            font-weight: 700; color: #64748b; cursor: pointer; transition: all 0.2s;
        }
        .duration-btn:hover { border-color: var(--primary-blue); color: var(--primary-blue); }
        .duration-btn.selected { background: var(--primary-blue); color: white; border-color: var(--primary-blue); box-shadow: 0 5px 15px rgba(0, 86, 179, 0.3); }

        .input-title {
            width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 15px;
            font-size: 1rem; margin-bottom: 30px; outline: none; font-family: 'Inter', sans-serif;
        }
        .input-title:focus { border-color: var(--primary-blue); }

        .modal-actions { display: flex; gap: 15px; }
        .btn-confirm { flex: 1; background: var(--primary-blue); color: white; justify-content: center; }
        .btn-cancel { flex: 1; background: #f1f5f9; color: #64748b; justify-content: center; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    </style>
</head>

<body>
    
    <div class="modal-overlay" id="bookingModal">
        <div class="modal">
            <h2>Nova Reserva</h2>
            <p>Selecione a duração da reunião agora</p>

            <div class="duration-options">
                <button class="duration-btn" onclick="selectDuration(15)">15 min</button>
                <button class="duration-btn selected" onclick="selectDuration(30)">30 min</button>
                <button class="duration-btn" onclick="selectDuration(60)">1h</button>
                
            </div>

            <input type="text" id="meetingTitle" class="input-title" placeholder="Título da Reunião (Opcional)">

            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-confirm" onclick="confirmBooking()">Confirmar Reserva</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="status-panel" id="sidebar">
            <img src="https://globalsrv.com.br/wp-content/uploads/2023/02/Logo_60px_white.png" alt="Logo" class="sidebar-logo">
            
            <div class="room-info">
                <h1 id="mainStatus">SALA 01</h1>
                <p id="subStatus">Sala Principal</p>
            </div>

            <div class="current-time">
                <div class="clock" id="clock">00:00</div>
                <div class="date" id="date">...</div>
            </div>
        </div>

        <div class="schedule-panel">
            <div class="schedule-header">
                <h2>Agenda do Dia</h2>
                <div class="header-actions">
                    <button class="btn btn-reservar" id="btnNovaReserva" onclick="openModal()">
                        + Reservar
                    </button>
                    <a href="index.html" class="btn btn-voltar">Sair</a>
                </div>
            </div>
            <div id="reservation-list">
                <div style="color: #999; text-align: center; margin-top: 50px;">Carregando...</div>
            </div>
        </div>
    </div>

    <script>
        function updateTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const elClock = document.getElementById('clock');
            const elDate = document.getElementById('date');
            if(elClock) elClock.textContent = `${hours}:${minutes}`;
            if(elDate) {
                const opts = { weekday: 'long', day: 'numeric', month: 'long' };
                const dStr = now.toLocaleDateString('pt-BR', opts);
                elDate.textContent = dStr.charAt(0).toUpperCase() + dStr.slice(1);
            }
        }
        setInterval(updateTime, 1000);
        updateTime();
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA8crGl2xSoe8c0kRDA03CxRcsJtsH-Hz8",
            authDomain: "painel-engenharia-e2b60.firebaseapp.com",
            projectId: "painel-engenharia-e2b60",
            storageBucket: "painel-engenharia-e2b60.firebasestorage.app",
            messagingSenderId: "754848525033",
            appId: "1:754848525033:web:10dc9a0eba7395fc069e78"
        };

        const ROOM_COLLECTION = "sala1"; 
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- VARIÁVEIS GLOBAIS ---
        let roomIsBusy = false;
        let inactivityTimer;
        let selectedDuration = 30; // Padrão 30min

        // --- LÓGICA DO MODAL ---
        window.openModal = function() {
            if(roomIsBusy) {
                alert("Não é possível reservar agora: A sala está ocupada.");
                return;
            }
            document.getElementById('bookingModal').style.display = 'flex';
            // Reseta input
            document.getElementById('meetingTitle').value = "";
        }

        window.closeModal = function() {
            document.getElementById('bookingModal').style.display = 'none';
        }

        window.selectDuration = function(mins) {
            selectedDuration = mins;
            // Atualiza visual dos botões
            document.querySelectorAll('.duration-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        window.confirmBooking = async function() {
            const titleInput = document.getElementById('meetingTitle').value;
            const finalTitle = titleInput.trim() === "" ? "Reserva Tablet" : titleInput;

            const now = new Date();
            const end = new Date(now.getTime() + selectedDuration * 60000);

            try {
                closeModal(); // Fecha primeiro para dar feedback rápido
                
                await addDoc(collection(db, ROOM_COLLECTION), {
                    titulo: finalTitle,
                    inicio: now.toISOString(),
                    fim: end.toISOString(),
                    organizer: "Agendamento Local",
                    criadoEm: new Date().toISOString()
                });
                // A tela atualizará sozinha via onSnapshot
            } catch (error) {
                console.error("Erro:", error);
                alert("Erro ao realizar reserva.");
            }
        }

        // --- INATIVIDADE ---
        const resetTimer = () => {
            clearTimeout(inactivityTimer);
            if (roomIsBusy) return; // Se ocupado, não sai
            // Se modal estiver aberto, não sai também (opcional, mas boa prática)
            if (document.getElementById('bookingModal').style.display === 'flex') return;

            inactivityTimer = setTimeout(() => {
                window.location.href = "index.html";
            }, 60000);
        };

        window.onload = resetTimer;
        document.onmousemove = resetTimer;
        document.onclick = resetTimer;
        document.ontouchstart = resetTimer;


        // --- FIREBASE LISTENER ---
        function formatIsoTime(isoString) {
            if (!isoString) return "--:--";
            try {
                const date = new Date(isoString);
                if(isNaN(date.getTime())) return isoString; 
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${hours}:${minutes}`;
            } catch (e) { return isoString; }
        }

        const q = query(collection(db, ROOM_COLLECTION), orderBy("inicio"));

        onSnapshot(q, (snapshot) => {
            const list = document.getElementById('reservation-list');
            list.innerHTML = ""; 
            const today = new Date();
            let hasEventsToday = false;

            snapshot.forEach((doc) => {
                const data = doc.data();
                const rawStart = data.inicio || data.start;
                const rawEnd = data.fim || data.end;
                
                if(!rawStart) return;
                const eventDate = new Date(rawStart);
                if (eventDate.toDateString() !== today.toDateString()) return;

                hasEventsToday = true;

                const titulo = data.titulo || data.title || "Sem Título";
                const organizador = data.organizer || "Reservado"; 
                const displayStart = formatIsoTime(rawStart);
                const displayEnd = formatIsoTime(rawEnd);

                const html = `
                <div class="reservation-card" data-raw-start="${rawStart}" data-raw-end="${rawEnd}" data-title="${titulo}">
                    <div class="time-slot">${displayStart} <span>até ${displayEnd}</span></div>
                    <div class="meeting-details">
                        <div class="meeting-title">${titulo}</div>
                        <div class="organizer"><div class="avatar">${organizador ? organizador[0] : 'T'}</div>${organizador}</div>
                    </div>
                    <span class="tag upcoming">CONFIRMADO</span>
                </div>`;
                list.insertAdjacentHTML('beforeend', html);
            });

            if (!hasEventsToday) {
                 list.innerHTML = '<div style="color: #999; text-align: center; margin-top: 50px;">Agenda livre por hoje.</div>';
            }

            checkStatus();
        });

        function checkStatus() {
            const now = new Date();
            let isBusy = false;
            let currentTitle = "";
            let currentTime = "";

            const cards = document.querySelectorAll('.reservation-card');

            cards.forEach(card => {
                const rawStart = card.getAttribute('data-raw-start');
                const rawEnd = card.getAttribute('data-raw-end');
                const title = card.getAttribute('data-title');

                if (rawStart && rawEnd) {
                    const startDate = new Date(rawStart);
                    const endDate = new Date(rawEnd);
                    if(isNaN(startDate.getTime())) return;

                    const tag = card.querySelector('.tag');

                    if (now >= startDate && now < endDate) {
                        isBusy = true; 
                        currentTitle = title;
                        const s = String(startDate.getHours()).padStart(2,'0') + ":" + String(startDate.getMinutes()).padStart(2,'0');
                        const e = String(endDate.getHours()).padStart(2,'0') + ":" + String(endDate.getMinutes()).padStart(2,'0');
                        currentTime = `${s} - ${e}`;
                        
                        card.style.borderLeftColor = "var(--danger-red)";
                        card.style.background = "#fff1f2";
                        card.classList.add('active-card');
                        if(tag) { tag.className = "tag ongoing"; tag.textContent = "EM ANDAMENTO"; }
                    }
                    else {
                        card.style.borderLeftColor = "var(--primary-blue)";
                        card.style.background = "white";
                        card.classList.remove('active-card');
                        if(tag) {
                            if (now >= endDate) {
                                tag.className = "tag"; tag.textContent = "FINALIZADO";
                                tag.style.background = "#f3f4f6"; tag.style.color = "#9ca3af";
                            } else {
                                tag.className = "tag upcoming"; tag.textContent = "CONFIRMADO";
                            }
                        }
                    }
                }
            });

            roomIsBusy = isBusy;
            
            // Gerencia o estado do botão "Nova Reserva"
            const btnReserva = document.getElementById('btnNovaReserva');
            if(roomIsBusy) {
                btnReserva.disabled = true;
                btnReserva.innerHTML = "⛔ Ocupado";
            } else {
                btnReserva.disabled = false;
                btnReserva.innerHTML = "+ Reservar";
            }

            resetTimer(); 
            toggleHybridMode(isBusy, currentTitle, currentTime);
        }

        function toggleHybridMode(active, title, time) {
            const body = document.body;
            const mainStatus = document.getElementById('mainStatus');
            const subStatus = document.getElementById('subStatus');

            if (active) {
                if (!body.classList.contains('is-busy')) body.classList.add('is-busy');
                mainStatus.textContent = "OCUPADO";
                mainStatus.classList.add('status-ocupado');
                subStatus.innerHTML = `${title}<br><span style="font-size:0.8em; opacity:0.8; font-weight:400">Termina às ${time.split('-')[1]}</span>`;
                subStatus.classList.add('meeting-now');

            } else {
                body.classList.remove('is-busy');
                mainStatus.textContent = "SALA 01";
                mainStatus.classList.remove('status-ocupado');
                subStatus.textContent = "Sala Principal";
                subStatus.classList.remove('meeting-now');
            }
        }
        
        setInterval(checkStatus, 5000);
    </script>
</body>
</html>
